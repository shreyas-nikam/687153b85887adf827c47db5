id: 687153b85887adf827c47db5_documentation
summary: Risk Management Framework Lab 1 Documentation
feedback link: https://docs.google.com/forms/d/e/1FAIpQLSfWkOK-in_bMMoHSZfcIvAeO58PAH9wrDqcxnJABHaxiDqhSA/viewform?usp=sf_link
environments: Web
status: Published
# QuLab: Risk-Sensitive Pricing Simulation

## Introduction to Risk Management Concepts
Duration: 05:00

Welcome to this codelab, where we will delve into the critical concepts of risk-sensitive pricing within financial transactions, using a simulated loan portfolio as our case study. Understanding how to price risk effectively is paramount for the financial health and profitability of any lending institution.

This lab provides a hands-on exploration of how different pricing strategies impact a portfolio's risk profile and bottom line. We will compare a simple risk-insensitive approach with a more sophisticated risk-sensitive one that incorporates key risk metrics.

The core concepts we will cover include:

*   **Expected Loss (EL):** The average loss expected on a transaction over a specific period. It is calculated as the product of Principal, Probability of Default (PD), and Loss Given Default (LGD).
    $$ \text{Expected Loss} = \text{Principal} \times \text{Probability of Default}_{PD} \times \text{Loss Given Default}_{LGD} $$
*   **Economic Capital (EC):** The amount of capital required to absorb potential unexpected losses over a specific confidence level and time horizon. It acts as a buffer against volatility and downside risk beyond the expected loss. In this simplified model, we approximate it using a multiplier ($\text{UL factor}$) on the Expected Loss.
    $$ \text{Economic Capital} \approx \text{Expected Loss} \times \text{UL Factor} = \text{Principal} \times \text{PD} \times \text{LGD} \times \text{UL Factor} $$
*   **Net Risk Adjusted Reward (NRAR):** The profit generated by a transaction after accounting for all costs, including funding, operations, and the expected loss.
    $$ \text{NRAR} = \text{Total Income} - \text{Total Funding Cost} - \text{Total Operating Cost} - \text{Expected Loss} $$
*   **Risk-Adjusted Return on Risk-Adjusted Capital (RARORAC):** A key profitability metric that measures the return generated by a transaction relative to the economic capital it consumes. It provides a standardized way to compare the profitability of different transactions while accounting for their risk.
    $$ \text{RARORAC} = \frac{\text{Net Risk Adjusted Reward}}{\text{Economic Capital}} $$

By simulating transactions and applying these concepts, you will gain a practical understanding of why pricing discipline is crucial for building and maintaining a profitable and resilient portfolio.

This Streamlit application is structured into three main sections, accessible via the sidebar:

1.  **Introduction:** Provides an overview of the lab and its learning objectives (which you are currently reading).
2.  **Simulation:** Allows you to run the core pricing simulation and analyze the results.
3.  **Conclusion:** Summarizes the key takeaways and insights from the simulation.

Let's get started by setting up the application environment.

## Setting up the Application Environment
Duration: 05:00

To run this application, you'll need Python and Streamlit installed.

1.  **Install Streamlit:** If you don't have Streamlit installed, open your terminal or command prompt and run:

    ```console
    pip install streamlit pandas numpy plotly
    ```
    We also install pandas, numpy, and plotly as they are used by the application.

2.  **Save the Code:** Create a directory for your application (e.g., `quLab`) and save the provided code into the following file structure:

    ```
    quLab/
    ├── app.py
    └── application_pages/
        ├── __init__.py  (Optional, but good practice for packages)
        ├── introduction.py
        ├── simulation.py
        └── conclusion.py
    ```

    Save the code blocks provided in the prompt into the corresponding files. Ensure the content matches exactly. For `application_pages/__init__.py`, you can just create an empty file or add `from . import introduction, simulation, conclusion`.

    <aside class="positive">
    Make sure the filenames and directory structure match exactly as described for the application to run correctly.
    </aside>

3.  **Run the Application:** Navigate to the `quLab` directory in your terminal and run the Streamlit application:

    ```console
    streamlit run app.py
    ```

    This will open the application in your web browser, usually at `http://localhost:8501`.

You should now see the "Introduction" page of the application in your browser. Use the sidebar navigation to move between sections.

## Exploring the Simulation Page - Data and Concepts in Action
Duration: 10:00

Navigate to the "Simulation" page using the sidebar select box. This page is where the core simulation runs and the results are displayed.

The page first generates a set of synthetic loan transactions. The number of transactions can be configured (it defaults to 100 in the code, but could be made interactive with a slider in a real app). Each transaction has properties like `Principal`, `Interest Rate`, `Tenor`, `PD` (Probability of Default), `LGD` (Loss Given Default), `Operational Cost Ratio`, and `Cost of Funds`.

```python
def generate_synthetic_transactions(num_transactions):
    # ... (code omitted for brevity)
    data = {
        'Principal': np.random.uniform(10000, 1000000, num_transactions),
        'Interest Rate': np.random.uniform(0.02, 0.15, num_transactions),
        'Tenor': np.random.randint(12, 120, num_transactions),
        'PD': np.random.uniform(0.001, 0.1, num_transactions),
        'LGD': np.random.uniform(0.4, 0.8, num_transactions),
        'Operational Cost Ratio': np.random.uniform(0.005, 0.02, num_transactions),
        'Cost of Funds': np.random.uniform(0.01, 0.05, num_transactions)
    }
    return pd.DataFrame(data)
```

The application then introduces the key risk and profitability concepts (EL, EC, NRAR, RARORAC) with their definitions and formulae, which you can expand to view.

```python
def calculate_expected_loss(principal, pd, lgd):
    return principal * pd * lgd

def calculate_economic_capital(principal, pd, lgd, ul_factor):
    return principal * pd * lgd * ul_factor

def calculate_net_risk_adjusted_reward(principal, interest_rate, tenor, funding_cost_rate, op_cost_ratio, expected_loss):
    total_income = principal * interest_rate * tenor
    total_funding_cost = principal * funding_cost_rate * tenor
    total_operating_cost = principal * op_cost_ratio * tenor
    net_risk_adjusted_reward = total_income - total_funding_cost - total_operating_cost - expected_loss
    return net_risk_adjusted_reward
```

These functions are used internally when calculating the metrics for each transaction under different pricing strategies. The `calculate_all_rarorac_components_df` function applies these calculations across the entire DataFrame.

```python
def calculate_all_rarorac_components_df(df, interest_rate_column, ul_factor):
    df_copy = df.copy()
    df_copy['Expected Loss'] = df_copy['Principal'] * df_copy['PD'] * df_copy['LGD']
    df_copy['Revenue'] = df_copy['Principal'] * df_copy[interest_rate_column] * df_copy['Tenor']
    df_copy['Operating Cost'] = df_copy['Principal'] * df_copy['Operational Cost Ratio'] * df_copy['Tenor']
    df_copy['Economic Capital'] = df_copy['Principal'] * df_copy['PD'] * df_copy['LGD'] * ul_factor
    # ... calculate NRAR and RARORAC
    df_copy['Net Risk Adjusted Return'] = df_copy['Revenue'] - df_copy['Expected Loss'] - df_copy['Operating Cost'] - (df_copy['Cost of Funds'] * df_copy['Principal'] * df_copy['Tenor'])
    df_copy['RARORAC'] = df_copy['Net Risk Adjusted Return'] / df_copy['Economic Capital']
    # ... handle division by zero/NaNs
    return df_copy
```

Before displaying the results, the application runs the core simulation logic, comparing two pricing strategies.

## Understanding the Pricing Strategies Simulation
Duration: 15:00

The heart of the simulation lies in comparing two pricing approaches for each synthetic transaction:

1.  **Risk-Insensitive Pricing:** This approach simply uses the initially generated `Interest Rate` for each transaction. It calculates the NRAR and RARORAC based on this rate, without attempting to adjust the rate based on risk or a target return. This mimics a scenario where pricing is driven by market rates or other factors, but not explicitly by the transaction's individual risk profile relative to required capital.

2.  **Risk-Sensitive Pricing:** This approach attempts to find an `Interest Rate` for each transaction such that its RARORAC meets or exceeds a predefined `hurdle_rate` (defaulting to 10% in the code). The `adjust_interest_rate` function performs this adjustment.

    ```python
    def adjust_interest_rate(row, hurdle_rate, ul_factor):
        # ... retrieve transaction parameters
        economic_capital = principal * pd * lgd * ul_factor

        if economic_capital == 0:
            return np.nan # Cannot calculate RARORAC

        min_interest_rate = 0.001 # Minimum possible rate
        max_interest_rate = 2.0 # Maximum possible rate (arbitrarily high)
        current_interest_rate = row['Interest Rate'] # Start with the original rate

        # Use binary search to find the interest rate that meets the hurdle
        for _ in range(100): # Limit iterations
            revenue = principal * current_interest_rate * tenor
            net_risk_adjusted_return = revenue - expected_loss - operating_cost - (cost_of_funds * principal * tenor)
            rarorac = net_risk_adjusted_return / economic_capital

            if rarorac >= hurdle_rate:
                max_interest_rate = current_interest_rate # Found a rate that works, try lower
            else:
                min_interest_rate = current_interest_rate # Rate too low, need higher

            if abs(max_interest_rate - min_interest_rate) < 1e-7:
                break # Found the rate within tolerance

            current_interest_rate = (min_interest_rate + max_interest_rate) / 2.0

        # Check if the hurdle rate was actually met or if it's impossible
        final_revenue = principal * current_interest_rate * tenor
        final_nrar = final_revenue - expected_loss - operating_cost - (cost_of_funds * principal * tenor)
        final_rarorac = final_nrar / economic_capital

        # If even at the max_interest_rate boundary after iterations, the hurdle isn't met,
        # and the gap is significant, assume it's not possible to meet the hurdle.
        if final_rarorac < hurdle_rate and abs(current_interest_rate - (max_interest_rate + min_interest_rate)/2.0) < 1e-7 and (hurdle_rate - final_rarorac) > 0.001:
             return np.nan # Impossible to meet hurdle

        return current_interest_rate
    ```

    This function employs an iterative method (similar to binary search) to find the interest rate. It starts with a range and repeatedly narrows it down until the RARORAC is close to the hurdle rate, or the rate range becomes very small. If even a very high interest rate cannot make the deal meet the hurdle (due to high risk/costs relative to principal/tenor), it might return `NaN`, indicating the deal is fundamentally unprofitable at any reasonable rate given the required return on capital.

The `simulate_pricing_strategies` function orchestrates this comparison, applying the calculations for both scenarios and adding the results as new columns to the DataFrame.

```python
def simulate_pricing_strategies(transactions_df, hurdle_rate, ul_factor):
    # ... (code omitted for brevity)
    df = transactions_df.copy()

    # Risk-Insensitive Pricing
    df['Interest Rate_Risk_Insensitive'] = df['Interest Rate'] # Use original rate
    df_ris = calculate_all_rarorac_components_df(df, 'Interest Rate_Risk_Insensitive', ul_factor)
    df['RARORAC_Risk_Insensitive'] = df_ris['RARORAC']
    df['Net Risk Adjusted Return_Risk_Insensitive'] = df_ris['Net Risk Adjusted Return']
    df['Economic Capital'] = df_ris['Economic Capital'] # EC is the same for both strategies

    # Risk-Sensitive Pricing
    df['Interest Rate_Risk_Sensitive'] = df.apply(lambda row: adjust_interest_rate(row, hurdle_rate=hurdle_rate, ul_factor=ul_factor), axis=1) # Adjust rate
    df_rs = calculate_all_rarorac_components_df(df, 'Interest Rate_Risk_Sensitive', ul_factor)
    df['RARORAC_Risk_Sensitive'] = df_rs['RARORAC']
    df['Net Risk Adjusted Return_Risk_Sensitive'] = df_rs['Net Risk Adjusted Return']

    return df
```

After the simulation, the application displays a table comparing key metrics for the first few transactions under both strategies, allowing you to see the calculated rates, RARORACs, and NRARs side-by-side.

## Analyzing the Simulation Results
Duration: 10:00

The simulation results are presented through a comparison table and two visualizations:

1.  **Comparison Table:** This table shows a side-by-side comparison for the first 10 transactions, displaying the original interest rate, the RARORAC and NRAR under risk-insensitive pricing, and the adjusted interest rate, RARORAC, and NRAR under risk-sensitive pricing, along with the calculated Economic Capital.
    <aside class="positive">
    Observe how the `Interest Rate_Risk_Sensitive` is often higher than the original `Interest Rate_Risk_Insensitive`, and how the `RARORAC_Risk_Sensitive` is often closer to or above the hurdle rate compared to `RARORAC_Risk_Insensitive`. Note the `NaN` values in the risk-sensitive columns, indicating deals where the hurdle rate could not be met.
    </aside>

2.  **RARORAC Distribution Histogram:** This histogram visually compares the distribution of RARORAC values for all simulated transactions under both pricing strategies. The red dashed line indicates the specified `hurdle_rate`.
    <aside class="positive">
    In the risk-insensitive distribution (blue), you will likely see a significant portion of deals falling below the hurdle rate. In contrast, the risk-sensitive distribution (orange) should show a higher concentration of deals at or above the hurdle rate, reflecting the adjustment process. The deals that couldn't meet the hurdle rate in the sensitive strategy (`NaN` values) are excluded from this histogram.
    </aside>

3.  **Interest Rate vs. Principal Scatter Plot (Risk-Sensitive):** This scatter plot visualizes the relationship between the Principal amount and the adjusted interest rate under the risk-sensitive strategy. The color of each point represents the final RARORAC achieved for that transaction.
    <aside class="positive">
    While the synthetic data doesn't perfectly simulate real-world correlations, this plot demonstrates the output of the risk-sensitive pricing. You might observe (depending on the random data) that deals with higher principal or inherent risk (though not directly shown here) might require higher adjusted interest rates to achieve the target RARORAC, visualized by warmer colors (indicating higher RARORAC) associated with potentially higher rates or less risky deals.
    </aside>

Analyzing these results helps solidify the understanding of how risk-sensitive pricing actively manages the portfolio's return relative to the risk capital consumed by each deal.

## Conclusion and Interpretation
Duration: 05:00

Navigate to the "Conclusion" page to read the final summary and interpretation provided by the application.

This simulation highlights a fundamental difference between risk-insensitive and risk-sensitive pricing:

*   **Risk-Insensitive Pricing:** By accepting deals at potentially sub-optimal rates relative to their risk, an institution risks accumulating a portfolio with many transactions that fail to adequately compensate for the economic capital they tie up. This can erode shareholder value and potentially lead to undercapitalization if unexpected losses occur. The simulation shows deals with `RARORAC_Risk_Insensitive` below the required hurdle rate.

*   **Risk-Sensitive Pricing:** By either repricing deals to meet a minimum RARORAC hurdle or rejecting them if the hurdle cannot be met, risk-sensitive pricing ensures that each transaction contributes positively to the portfolio's overall profitability relative to its risk. Deals marked as `NaN` in the risk-sensitive columns represent those that are inherently too risky or costly to justify accepting at a rate that meets the required return on capital.

The application demonstrates that implementing a risk-sensitive pricing framework, grounded in metrics like Expected Loss, Economic Capital, NRAR, and RARORAC, is not just a regulatory requirement but a crucial strategic tool for sustainable growth and effective capital management in lending. It aligns pricing decisions with the true economic cost and risk of extending credit.

<aside class="positive">
Consider how an interactive application like this could be used to train new relationship managers or credit officers on the importance of risk-based pricing and RARORAC hurdles in their daily decision-making.
</aside>

You have now completed this codelab, exploring the core concepts and practical implications of risk-sensitive pricing using a simple Streamlit application simulation.

References:

[1] PRMIA Operational Risk Manager Handbook, Updated November 2015.
